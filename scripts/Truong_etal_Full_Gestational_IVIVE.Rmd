---
title: "Truong et al. (2024): Using Thyroid-Related Bioactivity Data for Full Human
  Gestational IVIVE"
author: "Kimberly Truong"
date:  "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: > 
  %\VignetteIndexEntry{Truong (2024) Full Human Gestational IVIVE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Overview

In this vignette, we show how to use the full human gestational model from *httk* to perform *in vitro-in vivo* extrapolation (IVIVE) on a relevant *in vitro* bioactivity dataset. Briefly, this demonstrates how to take thyroid-related *in vitro* bioactivity data from ToxCast, perform IVIVE using the 3-compartment steady state model and the full human pregnancy model from *httk*, and compare it with the latest exposure estimates from ExpoCast as a method of prioritization. This is detailed in Truong et al. 2024 (in preparation). 

Truong et al. 2024 describes a prioritization workflow for thyroid-related bioactivity data related to deiodinase inhibition and applies the full human gestational model to compute administered equivalent doses (AEDs) and bioactivity-to-exposure ratios (BERs) by integrating SEEM3 ExpoCast predictions. The figure below shows an overview of the workflow. 

![Figure 1 from *Truong et al.*](../figures/fig1-workflow-v2.png){width=100%}

This vignette covers the last step of the workflow "Targeted bioactivity:exposure ratios", and the previous three steps are done by executing `deiod_invitrodb_v3_5_processing.R`.

This vignette reproduces Figures 9 and 10 from Truong et al. 2024.

## HTTK Version 
This vignette was created with httk v2.3.0. This should be updated to the latest "main" branch of httk-dev. 

## Prepare for session 
```{r configure-knitr}
# this runs on my local but this would have to be changed to the path of the dir you git cloned to
knitr::opts_knit$set(root.dir = 'C:/Users/ktruong/OneDrive - Environmental Protection Agency (EPA)/Profile/Documents/thyroid_prioritization/doc/comptox-thyroid-httk')
options(rmarkdown.html_vignette.check_title = FALSE)

```

## Data Import 
We need to load in the processed *in vitro* bioactivity data. This was done by `deiod_invitrodb_v3_5_processing.R`, and results were saved in the `./data/invitrodb_v3_5_deiod_filtered_httk.RData` object.

```{r invitro-data}
rm(list = ls())
load('./data/invitrodb_v3_5_deiod_filtered_httk_121024.RData', verbose = TRUE)

```
### eval = execute.chunk 
Several chunks of code in this vignette have "eval = execute.chunk" and we set execute.chunk to be FALSE, by default. We do this to include all the code that was necessary to produce the figures but was not run when the vignette was built since some of these chunks take a considerable amount of time. You can still reproduce the end figures knitting the .Rmd file, since all the necessary and intermediate data objects are stored in `./data/invitrodb_v3_5_deiod_filtered_httk.RData`. If you want to rerun the whole workflow on your own, you must rerun all code from top to bottom, either by changing execute.chunk to TRUE or click on the "green arrow" in RStudio. 

```{r}
execute.chunk <- FALSE 
```

### Load libraries 
```{r libraries, message = FALSE}
library(httk)
library(data.table)
library(dplyr)
library(openxlsx)
library(ggpubr)
library(cowplot)
library(ggrepel)
library(latex2exp)
library(viridis)
library(scales)

```

# IVIVE using 3-compartment steady state model

## Examine Chemicals
Only 50 chemicals have experimental toxicokinetic (TK) parameters sufficient for *httk*. 
```{r exp-TK-chems, warning = FALSE}
# how many chems had experimental TK params?
human.data.pre <- subset(get_cheminfo(info = 'all', species = 'Human', 
                                      model = '3compartmentss'), 
                         DTXSID %in% ac50.dt$dsstox_substance_id)  

nrow(human.data.pre)

```
### In silico predictions of TK parameters
We need to supplement these with *in silico* predictions of TK parameters.
```{r insilico-preds, message=FALSE, warning=FALSE}
# predict Clint/fup values for missing chems 
# this loads new chem.physical_and_invitro.data table into the global env 
load_dawson2021() # most data for ToxCast chems
load_sipes2017() # most data for pharma compounds 
load_pradeep2020() # best ML method for in silico prediction 

```
### Examine missing chemicals 
```{r missing-chems, warning = FALSE}
human.httk.dt <- subset(ac50.dt, dsstox_substance_id %in% get_cheminfo(info = 'DTXSID', 
                                                                       species = 'Human', 
                                                                       model = '3compartmentss', 
                                                                       median.only = TRUE))
# a lot of PFAS dropped out (n = 13)
setdiff(ac50.dt$chnm, human.httk.dt$chnm)

missing.dtxsids <- setdiff(ac50.dt$dsstox_substance_id, human.httk.dt$dsstox_substance_id)

```
### Default to chems used previously (for now)
```{r, eval = execute.chunk}
e <- new.env(parent = emptyenv())
(load('./data/invitrodb_v3_5_deiod_filtered_httk.RData', envir = e))

human.httk.dt <- subset(ac50.dt, dsstox_substance_id %in% e$ivive.moe.tb[, dtxsid])

```

## Predicting AEDs based on Css50 (in plasma)
There are two ways to compute an oral AED in *httk*:  
1. compute a steady-state plasma concentration via `calc_mc_css` and then:
$$ 
AED = \frac{AC_{50}}{CSS_{50}}
$$
2. use `calc_mc_oral_equiv` passing the AC50 to the `conc` argument and specifying `which.quantile = c(0.5)`.  

```{r 3compss-aeds, warning = FALSE, message = FALSE, eval = execute.chunk}

for (i in 1:nrow(human.httk.dt)) {
  
  message('Calculating for chemical: ', human.httk.dt$chnm[i], '\n')
  set.seed(123)
  out <- calc_mc_css(dtxsid = human.httk.dt$dsstox_substance_id[i], 
                     species = 'Human', 
                     daily.dose = 1, 
                     which.quantile = c(0.5, 0.95), 
                     model = '3compartmentss', 
                     output.units = 'uM', 
                     suppress.messages = TRUE) # This does not work- report bug
  
  human.httk.dt$mc.css50[i] <- out["50%"]
  # human.httk.df$mc.css95[i] <- out["95%"]
  
  set.seed(123)
  oralequiv.out <- calc_mc_oral_equiv(conc = human.httk.dt$min_ac50[i], 
                                      dtxsid = human.httk.dt$dsstox_substance_id[i], 
                                      species = 'Human', 
                                      which.quantile = c(0.5, 0.95), 
                                      input.units = 'uM',
                                      output.units = 'mgpkgpday',
                                      model = '3compartmentss', 
                                      restrictive.clearance = TRUE, 
                                      suppress.messages = TRUE)
  
  human.httk.dt$oral_equiv50[i] <- oralequiv.out["50%"]
  # human.httk.df$oral_equiv95[i] <- oralequiv.out["95%"]
  
}                                                                

# human.httk.df[, calc.aed95:= min_ac50 / mc.css95]
# human.httk.df[, fold_diff95 := log10(oral_equiv95/calc.aed95)]
human.httk.dt[, calc.aed50 := min_ac50/mc.css50]
human.httk.dt[, fold_diff50 := log10(oral_equiv50/calc.aed50)]

```

## Load ExpoCast predictions (SEEM3)
```{r seem3, eval = execute.chunk}
load("./data/chem.preds-2018-11-28.RData", verbose = TRUE)
SEEM = chem.preds 
rm(chem.preds)

message(paste("SEEM3 predictions exist for", length(unique(SEEM$dsstox_substance_id)), "chemicals", 
              sep = " "))

# let's use the aed values from the division 
human.httk.dt2 <- human.httk.dt[, c('dsstox_substance_id', 'chnm', 
                                    'DIO1', 'DIO2', 'DIO3', 'IYD', 'min_ac50', 
                                    'mc.css50', 'calc.aed50')]

# integrate SEEM3 predictions with merge
human.httk.dt2.seem3 <- merge.data.table(human.httk.dt2, 
                                         SEEM[, c("dsstox_substance_id", "seem3", "seem3.u95")], 
                                         by = c("dsstox_substance_id"), 
                                         all.x = TRUE)

human.httk.dt2.seem3[, plasmaBER50 := calc.aed50/seem3.u95]
human.httk.dt2.seem3[, log.pBER50 := log10(plasmaBER50)]

# offload memory
rm(SEEM)

```

### Update RData 
```{r add-ivive-tb, eval = execute.chunk}
# update RData file with BER_plasma data 
# this helps save some time in knitting this vignette 
e <- new.env(parent = emptyenv())
(load('./data/invitrodb_v3_5_deiod_filtered_httk_121024.RData', envir = e))
e$ivive.moe.tb <- human.httk.dt2.seem3
setnames(e$ivive.moe.tb, "dsstox_substance_id", "dtxsid")
do.call("save", c(ls(envir = e),
                  list(envir = e, file ='./data/invitrodb_v3_5_deiod_filtered_httk_121024.RData')))

```

# IVIVE using the Full Human Gestational Model

### Compute half-lives
```{r half-lives, warning = FALSE}
for (i in 1:nrow(ivive.moe.tb)) {
  ivive.moe.tb$half.life[i] <- calc_half_life(dtxsid = ivive.moe.tb$dtxsid[i]) # in hrs
  ivive.moe.tb$half.life.days <- ivive.moe.tb$half.life/24 # in days
}

```

## Simulate full-term human pregnancy model 
```{r fullpreg-sim, message = FALSE, warning = FALSE, eval = execute.chunk}

# tissues where DIO enzymes live 
impacted_tissues <- c('Cliver', 'Cthyroid', 'Cfliver', 'Cfbrain', 'Cfthyroid', 
                      'Cplacenta', 'Cconceptus', 'Cplasma')
targets <- c('DIO1', 'DIO2', 'DIO3', 'IYD')

# max conc in every tissue for every chemical
Cmax.tissues <- data.frame(matrix(NA, ncol = length(impacted_tissues) + 1, 
                                  nrow = nrow(ivive.moe.tb), 
                                  dimnames = list(NULL, c('dtxsid', impacted_tissues))))

for(i in 1:nrow(ivive.moe.tb)) {
  
  message('Calculating for chemical: ', ivive.moe.tb$chnm[i], '\n')
  
  sol.out <- solve_full_pregnancy(dtxsid = ivive.moe.tb$dtxsid[i],
                            daily.dose = 1, 
                            doses.per.day = 1,
                            time.course = seq(0, 40*7, 1/24), # view solution by hour
                            track.vars = impacted_tissues)

  
  # get max of every column re: compt 
  Cmax.tissues[i, impacted_tissues] <- apply(sol.out[, impacted_tissues], 2, max, na.rm = T)
  Cmax.tissues[i, 'dtxsid'] <- ivive.moe.tb$dtxsid[i]
  
}

```

## Calculate AEDs by Target and Tissue
```{r preg-aeds, eval = execute.chunk}
tissue.aeds <- list()

# tissues specific for each target 
tissue_list <- list(DIO1 = c('Cliver', 'Cfliver', 'Cthyroid', 'Cfthyroid', 'Cconceptus'), 
                    DIO2 = c('Cthyroid', 'Cfthyroid', 'Cfbrain', 'Cconceptus'), 
                    DIO3 = c('Cthyroid', 'Cfthyroid', 'Cfbrain', 'Cplacenta', 'Cconceptus'), 
                    IYD = c('Cthyroid', 'Cfthyroid', 'Cconceptus'))

for (i in names(tissue_list)) {
  active.chem.ind <- which(!is.na(ivive.moe.tb[, ..i]))
  n.chems <- length(active.chem.ind)
  
  empty.mat <- matrix(NA, nrow = n.chems, ncol = length(tissue_list[[i]]) + 1)
  df.target <- data.frame(empty.mat)
  colnames(df.target) <- c('dtxsid', tissue_list[[i]])
 
  df.target[, 2: (length(tissue_list[[i]])+1) ] <- mapply(function(x,y) x/y, ivive.moe.tb[active.chem.ind, ..i], Cmax.tissues[active.chem.ind, tissue_list[[i]]])
  
  df.target$dtxsid <- ivive.moe.tb$dtxsid[active.chem.ind]
  tissue.aeds[[i]] <- df.target
}

```

### Update RData file with tissue-based AEDs
```{r preg-aeds-RData, eval = execute.chunk}
e <- new.env(parent = emptyenv())
load('./data/invitrodb_v3_5_deiod_filtered_httk_121024.RData', envir = e)
e$tissue.aeds <- tissue.aeds
do.call("save", c(ls(envir = e), list(envir = e, file ='./data/invitrodb_v3_5_deiod_filtered_httk_121024.RData')))

```

## Figure 9: Priority Chemicals based on maternal-fetal BERs

```{r fig9}
impacted_tissues <- c('Cliver', 'Cthyroid', 'Cfliver', 'Cfbrain', 'Cfthyroid', 
                      'Cplacenta', 'Cconceptus', 'Cplasma')

get_ber_data <- function(name, df) {
  
  df$exposure <- ivive.moe.tb$seem3.u95[match(df$dtxsid, ivive.moe.tb$dtxsid)]
  df.m <- df %>% select(-exposure) %>%
    reshape2::melt(id.vars = c('dtxsid'), 
                   variable.name = 'compt', value.name = 'aed')
  df.m$exposure <- ivive.moe.tb$seem3.u95[match(df.m$dtxsid, ivive.moe.tb$dtxsid)]
  df.m$ber = df.m$aed/df.m$exposure
  df.m2 <- df.m %>% 
    select(-exposure) %>%
    reshape2::melt(id.vars = c('dtxsid', 'compt', 'ber'))
  
  # add melted ExpoCast data as rows for each unique chem 
  expocast.dat <- df %>% select(dtxsid, exposure) %>% 
    reshape2::melt(id.vars = c('dtxsid'))
  
  df.m2 <- bind_rows(df.m2, expocast.dat)
  df.m2$value <- log10(df.m2$value)
  df.m2$ber <- log10(df.m2$ber)
  df.m2$chnm <- ivive.moe.tb$chnm[match(df.m2$dtxsid, ivive.moe.tb$dtxsid)]
  df.m2$enzyme <- name
  return(df.m2)
}

new.list <- Map(get_ber_data, names(tissue.aeds), tissue.aeds)
new_dat= bind_rows(new.list) 
setDT(new_dat)

# order chemicals by the most sensitive tissue endpoint 
new_dat[, min_ber := min(ber, na.rm = TRUE), keyby = .(enzyme, dtxsid)]

# exposure values are dependent on dtxsid not httk compt 
new_dat[variable == 'exposure', compt := 'exposure']
new_dat[variable == 'aed' & min_ber == ber, most_sensitive_tissue := compt, by = .(enzyme, dtxsid)]

new_dat[compt %in% impacted_tissues[grep('f', impacted_tissues)], body := 'fetal']
new_dat[compt %in% c('Cliver', 'Cthyroid'), body := 'maternal']
new_dat[compt %in% c('Cplacenta', 'Cconceptus'), body := 'conceptus']
new_dat[compt == "exposure", body := "exposure"]

new_dat[compt %in% impacted_tissues[grep('liver', impacted_tissues)], 
        tissue := 'liver']
new_dat[compt %in% impacted_tissues[grep('thyroid', impacted_tissues)], 
        tissue := 'thyroid']
new_dat[compt == 'Cfbrain', tissue := 'brain']
new_dat[compt == 'Cplacenta', tissue := 'placenta']
new_dat[compt == "Cconceptus", tissue := 'conceptus']
new_dat[compt == 'exposure', tissue := 'exposure'] 

# convert tissue and body variables to factors
new_cols <- c('body', 'tissue')
new_dat[, (new_cols) := lapply(.SD, factor), .SDcols = new_cols]
new_dat <- new_dat[order(min_ber), .SD, keyby = .(enzyme)]

min_val <- new_dat[min_ber < 3, min(value), by = enzyme][, min(V1)]
max_val <- new_dat[value != "Inf" & min_ber < 3, max(value), by = enzyme][, max(V1)]
ylims <- c(floor(min_val), ceiling(max_val))

# generate a set of 3 viridis colors for lifestage
my_viridis_colors <- viridis(n = 3)

# change order of tissue and body for plotting purposes 
new_dat$body <- factor(new_dat$body, levels = c("conceptus", "fetal", "maternal", "exposure"))
new_dat$tissue <- factor(new_dat$tissue, levels = c("conceptus", "placenta", "thyroid", "brain", "liver", "exposure"))

listgg <- list()
for(k in names(tissue.aeds)) {
  
  aeds <- new_dat[enzyme == k & ber < 3]
  chems <- new_dat[enzyme == k & ber < 3, dtxsid]
  exposures <- new_dat[enzyme == k & variable == "exposure" & dtxsid %in% chems]
  
  listgg[[k]] <- ggplot(data = rbind(aeds, exposures), 
                        mapping = aes(x = reorder(chnm, -min_ber), 
                                      y = value)) +
    geom_point(aes(shape = tissue, color = body), 
               alpha = 0.65, size = 3, stroke = 1.15, 
               show.legend = T) +
    scale_shape_manual(values = c('brain' = 19,
                                  'exposure' = 18, 
                                  'liver' = 17,
                                  'placenta' = 15, 
                                  'thyroid' = 8, 
                                  'conceptus' = 6),
                       drop = F) + # this makes sure all levels of a factor are displayed even if unused 
    scale_color_manual(values = c('maternal' = my_viridis_colors[1], 'fetal' = my_viridis_colors[2], 
                                  'conceptus' = my_viridis_colors[3], 'exposure' = "dimgrey")) +
    labs(x = 'Chemical', y = 'Oral AED or Exposure (log10 mg/kg-bw/day)', title = k) +
    theme_bw() +
    theme(legend.position = "none",
          plot.title = element_text(size = 18, face = "bold"), 
          axis.title = element_text(size = 16), 
          legend.title = element_blank(), 
          axis.text = element_text(size = 14), 
          legend.text = element_text(size = 14)) +
    scale_y_continuous(breaks = seq(ylims[1], ylims[2], 1), 
                       limits = ylims) +
    coord_flip()
}

# remove extra axis labels 
listgg$IYD <- listgg$IYD + labs(x = '', y = '')
listgg$DIO3 <- listgg$DIO3 + 
  labs(x = '') + 
  theme(axis.text.y = element_text(size = 13))

listgg$DIO1 <- listgg$DIO1 + labs(y = '')
listgg$DIO2 <- listgg$DIO2 + 
  guides(
    shape = guide_legend(ncol = 2, byrow = F), 
    color = guide_legend(ncol = 2, byrow = F)
  ) +
  theme(legend.position = "bottom",
   legend.direction = "horizontal")

fig9 <- ggdraw() +
  draw_plot(listgg$DIO1, x = 0, y = 0.5, width = 0.5, height = 0.5) +
  draw_plot(listgg$DIO2, x = 0, y = 0, width = 0.5, height = 0.5) +
  draw_plot(listgg$IYD, x = 0.52, y = 0.75, width = 0.48, height = 0.25) +
  draw_plot(listgg$DIO3, x = 0.5, y = 0, width = 0.5, height = 0.75)

ggsave(plot = fig9,
       units = "in",
       dpi = 300,
       width = 21.33, height = 11,
       device = "tiff",
       filename = "./figures/300dpi/preg_prioritization_by_BER-v2.tiff")

ggsave(plot = fig9,
       units = "in",
       dpi = 300,
       width = 21.33, height = 11,
       device = "png",
       filename = "./figures/preg_prioritization_by_BER-v2.png")

```

### update RData File with maternal-fetal BERs
```{r mat-fet-bers-Rdata, eval = execute.chunk}
# update RData file with melted data for ggplot
# i.e. chemicals ranked by tissue and lifestage-specific BERs with exposure estimates from ExpoCast
e <- new.env(parent = emptyenv())
load('./data/invitrodb_v3_5_deiod_filtered_httk_121024.RData', envir = e)
e$tissue.bers <- new_dat
do.call("save", c(ls(envir = e), list(envir = e, file ='./data/invitrodb_v3_5_deiod_filtered_httk_121024.RData')))

```

# Comparing IVIVE models for BER prioritization 

## Figure 10: Understanding and Interpreting Maternal-Fetal BERs 
```{r fig10, warning = FALSE}
targets <- c('DIO1', 'DIO2', 'DIO3', 'IYD')

# table matching scatterplot subplots with all calculated BERs
# every enzyme x chem x min BER constitutes a row 
enzxchem.tb <- tissue.bers[!is.na(most_sensitive_tissue), 
                       .(chnm, min_ber, most_sensitive_tissue, body, tissue), by = .(enzyme, dtxsid)]
# rows ordered by enzyme and within each enzyme group, ordered by min_ber 
enzxchem.tb.sorted <- enzxchem.tb[order(min_ber), .SD, keyby = .(enzyme)] 

# collapse multiple most-sensitive tissues 
# this really only applies to Ergocalciferol 
melt.foreach.dio <- enzxchem.tb.sorted[, most_sensitive_compts := paste(most_sensitive_tissue, collapse = ", "), by = .(enzyme, dtxsid)][, .(chnm, min_ber, most_sensitive_compts), by = .(enzyme, dtxsid)]
melt.foreach.dio2 <- unique(melt.foreach.dio)

# min BER matrix
min.ber.mat <- dcast(melt.foreach.dio2[, 1:4], 
                     dtxsid + chnm ~ enzyme, value.var = c('min_ber'))
setDT(min.ber.mat)
min.ber.mat[, min_across_enzyme := pmin(DIO1, DIO2, DIO3, IYD, na.rm = T)]
min.ber.mat <- min.ber.mat[order(min_across_enzyme)]

# find the target corresponding to the min_across_enzyme
min.ber.mat[, enzyme := mapply(function(x) targets[x], apply(min.ber.mat[, targets, with = FALSE], 1, which.min))]

# merge data on most sensitive tissues reflecting min BER 
# this ensures an extra row for Ergocalciferol to represent the multiple sensitive tissue endpoints 
new.ranking.tissues <- merge.data.table(min.ber.mat, 
                                 enzxchem.tb.sorted, 
                                 by = c('dtxsid', 'chnm', 'enzyme'), 
                                 all.x = TRUE)
setnames(new.ranking.tissues, old = 'enzyme', new = 'target_min')

# round all BERs to 2 decimal places for easy table viewing 
ranked.by.plasma50 <- ivive.moe.tb[, lmoe50 := round(log.pBER50, digits = 2)][order(lmoe50)]

final.new.ranking <- new.ranking.tissues[, -c("target_min", "min_ber", "most_sensitive_compts")]
final.new.ranking[, c(targets, "min_across_enzyme") := lapply(.SD, round, digits = 2), 
                  by = seq_len(nrow(final.new.ranking)), .SDcols = c(targets, "min_across_enzyme")]
final.new.ranking <- final.new.ranking[order(min_across_enzyme)]

# comparing tissue BER with plasma BER from 3compss model 
plasma.tissue.bers <- merge.data.table(ranked.by.plasma50[, c('dtxsid', 'chnm', 'lmoe50')], 
                           final.new.ranking[, -c('chnm')], 
                           by = c('dtxsid'))

setnames(plasma.tissue.bers, old = colnames(plasma.tissue.bers)[3:8], 
         new = c('plasma_BER50', 'DIO1_BER', 'DIO2_BER', 'DIO3_BER', 'IYD_BER', 'min_BER'))

plasma.tissue.bers <- plasma.tissue.bers[order(min_BER)]
write.xlsx(plasma.tissue.bers, "./tables/plasma_and_tissueBERs.xlsx", colnames = T)

# hide double label of Ergocalciferol 
# this occurred because min AED for this chemical was achieved in both maternal/fetal thyr
plasma.tissue.bers[which(plasma.tissue.bers$chnm %in% c("Ergocalciferol", "Morin hydrate"))[c(2,4)], chnm := NA_character_]

max_ber <- max(plasma.tissue.bers[, c('plasma_BER50', 'DIO1_BER', 'DIO2_BER', 'DIO3_BER', 'IYD_BER')], na.rm = T)
min_ber <- min(plasma.tissue.bers[, c('plasma_BER50', 'DIO1_BER', 'DIO2_BER', 'DIO3_BER', 'IYD_BER')], na.rm = T)
ber.lims <- c(floor(min_ber), ceiling(max_ber))

# theme for the next 2 figures 
my_theme <- theme_bw() +
  theme(axis.title = element_text(size = 14, face = "bold"), 
        axis.text = element_text(size = 12), 
        legend.text = element_text(size = 12))
  
preg.vs.nonpreg.pp <- ggplot(data = plasma.tissue.bers, aes(x = plasma_BER50, y = min_BER)) +
  geom_point(alpha = 0.75, size = 3, 
             show.legend = T) +
  # scale_shape_manual(values = c('brain' = 19,
  #                               'liver' = 17,
  #                               'placenta' = 15, 
  #                               'thyroid' = 8, 
  #                               'conceptus' = 7), 
  #                    drop = F) + # this makes sure all levels of a factor are displayed even if unused 
  # scale_color_manual(values = c('maternal' = 'darkviolet', 
  #                               'fetal' = 'forestgreen', 
  #                               conceptus = 'pink')) +
  geom_abline(slope = 1, linewidth = 1, linetype = 'solid', color = "#666666") +
  geom_abline(aes(slope = 1, intercept = 1), linetype = 'longdash', color = 'grey', linewidth = 1) + # default linesize = 1
  geom_abline(aes(slope = 1, intercept = -1), linetype = 'longdash', color = 'grey', linewidth = 1) +
  geom_label_repel(aes(label = chnm), 
                   size = 5, 
                   force = 28) +
  my_theme +
  theme(legend.position = 'bottom', 
        legend.direction = 'horizontal',
        legend.title = element_blank()) + 
  scale_x_continuous(breaks = seq(ber.lims[1], ber.lims[2], 1), 
                     limits = ber.lims) +
  scale_y_continuous(breaks = seq(ber.lims[1], ber.lims[2], 1), 
                     limits = ber.lims) +
  labs(x = 'plasma BER using 3compss model', y = 'min BER across DIO/IYD targets and tissues')

# plot SEEM3 uncertainty
ivive.moe.tb$uncertainty = log10(ivive.moe.tb$seem3.u95/ivive.moe.tb$seem3)
plasma.tissue.bers$uncertainty <- ivive.moe.tb$uncertainty[match(plasma.tissue.bers$dtxsid, ivive.moe.tb$dtxsid)]

min.min.ber <- min(plasma.tissue.bers$min_BER)
max.min.ber <- max(plasma.tissue.bers$min_BER)
min.ber.lims <- c(floor(min.min.ber), ceiling(max.min.ber))
max.uncertainty <- max(plasma.tissue.bers$uncertainty)

seem3pp <- ggplot(data = plasma.tissue.bers[-c(3,17), ], 
       mapping = aes(x = min_BER, 
                     y = uncertainty)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_label_repel(aes(label = chnm),
                   data = subset(plasma.tissue.bers, min_BER < 0 | uncertainty > 4),
                   force = 25,
                   size = 5) +
  my_theme +
  theme(legend.position = 'bottom', 
        legend.direction = 'horizontal',
        legend.title = element_blank()) + 
  scale_x_continuous(breaks = seq(min.ber.lims[1], min.ber.lims[2], 1), 
                     limits = min.ber.lims) +
  scale_y_continuous(breaks = seq(0, ceiling(max.uncertainty), 1), 
                     limits = c(0, ceiling(max.uncertainty))) +
  labs(x = 'min BER by Chemical', y = TeX(r'($log_{10}ExpoCast_{u95} - log_{10}ExpoCast_{med}$)'))

median(plasma.tissue.bers$min_BER[-3])
#> [1] 3.38

bers2 <- plot_grid(preg.vs.nonpreg.pp, seem3pp, 
          labels = "AUTO", label_size = 20)

ggsave(plot = bers2, 
       units = "in", 
       dpi = 300, 
       width = 18.53, height = 8.32, 
       device = "tiff", 
       filename = "./figures/300dpi/BER_uncertainty-v2.tiff")

ggsave(plot = bers2, 
       units = "in", 
       dpi = 300, 
       width = 18.53, height = 8.32, 
       device = "png", 
       filename = "./figures/BER_uncertainty-v2.png")


```


